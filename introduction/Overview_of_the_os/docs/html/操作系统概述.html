<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="css/prism.min.css"/><link rel="stylesheet" type="text/css" href="css/katex.min.css"/><link rel="stylesheet" type="text/css" href="css/wolai.css"/><title>操作系统概述 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body class="font-kai"><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="操作系统概述" class="main-title"></div></div></header><article><h2 id="78v5tgCPZQLrBxN3d6GtAY" class="wolai-block"><span class="inline-wrap">为什么要学习操作系统</span></h2><div id="7vZtTKmfeegtTpHK79idwd" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>像学习微积分、离散数学那样，重走从无到有的发现历程，理解学科中的</u></span><span class="green inline-wrap"><u><b>基本动机</b></u></span><span class="green inline-wrap"><u>、</u></span><span class="green inline-wrap"><u><b>基本方法</b></u></span><span class="green inline-wrap"><u>、</u></span><span class="green inline-wrap"><u><b>里程碑</b></u></span><span class="green inline-wrap"><u>以及</u></span><span class="green inline-wrap"><u><b>走过的弯路</b></u></span><span class="inline-wrap">。最终达到</span><span class="green inline-wrap"><b>应用、创新和革命</b></span><span class="inline-wrap">的目的</span></div><div id="n2ZURennhZf3tRvr2Z9hjq" class="blue wolai-block wolai-text"><div><span class="inline-wrap">操作系统的基本动机：更快更好地服务更多的应用</span></div></div><div id="jTQUmHnAYChkiwc4rzg9Gv" class="blue wolai-block wolai-text"><div><span class="inline-wrap">操作系统的基本方法：“Building Abstract”</span></div></div><div id="b7Kve7Lfk4MXRonwkVaWkm" class="blue wolai-block wolai-text"><div><span class="inline-wrap">操作系统的里程碑：Unix<span class="jill"></span>和<span class="jill"></span>Linux</span></div></div></div><h2 id="corMNN7emFpMRHTgZVHWNj" class="wolai-block"><span class="inline-wrap"><b>什么是操作系统？</b></span></h2><div id="kkR5cq78E4Nx8cj9QQdTjV" class="wolai-block wolai-text"><div><span class="inline-wrap">不用进行精准的定义，因为哪怕以“</span><span class="green inline-wrap"><u>管理计算机软件/硬件资源，为程序提供服务</u></span><span class="inline-wrap">”的程序来定义也是模糊的。如下图所示，通过</span><span class="green inline-wrap"><u>放宽对硬件和软件的设定限制</u></span><span class="inline-wrap">，可以得到不同的操作系统：</span></div></div><div id="pgihZw5wcypVG3vnkdCZRA" class="wolai-block"><figure class="wolai-center" style="width: 100%; flex-direction: column"><img src="media/image.png" style="width: 100%"/></figure></div><hr id="oRogzgX9hjdLiikTQfCBNn" class="wolai-block"/><h2 id="sSYnag4FrdBfGbPWWdn9hx" class="wolai-block"><span class="inline-wrap"><b>怎么理解操作系统</b></span></h2><div id="5wJcJRQY77qvBNSJUfVPgp" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>定义是对“全部”含义的精简表达</u></span><span class="inline-wrap">，而</span><span class="green inline-wrap"><u>理解操作系统的“全部”，就需要理解它发展的历史</u></span><span class="inline-wrap">——</span><span class="blue inline-wrap"><b>以硬件和软件的发展历史，来看中间层即操作系统的发展</b></span></div></div><h3 id="5cQE3BPscEdLUZcx1tyCwq" class="wolai-block"><span class="inline-wrap"><b>硬件</b></span><span class="inline-wrap">——logisim</span></h3><div id="29VechKwKLc7kLbZGDcPRk" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>《数字逻辑电路》所了解到一个</u></span><span class="blue inline-wrap"><u><b>由导线、时钟、逻辑门、寄存器构成的极简的公理系统</b></u></span><span class="green inline-wrap"><u>，能够支撑非常复杂的数字系统设计</u></span><span class="inline-wrap">。下面的<span class="jill"></span>logisim<span class="jill"></span>程序模拟数字电路的执行过程，它也是 </span><span class="inline-wrap"><a href="https://github.com/NJU-ProjectN/nvboard"><span>nvboard</span></a></span><span class="inline-wrap"> 的基本原理。这个例子还展示了 UNIX Philosophy 中命令行工具的</span><span class="blue inline-wrap"><b>协作原理</b></span><span class="inline-wrap">——C 程序 logisim 输出类似 </span><span class="inline-wrap"><code>A=0; B=1; ...</code></span><span class="inline-wrap"> 的数码管状态，而另一个程序负责解析这些输出并真实地 “画” 出来。</span></div></div><code-block id="wKc3zVHET2efW6ErQtbK3" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">wget</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-np</span> <span class="token parameter variable">-nH</span> --cut-dirs<span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-R</span> <span class="token string">"index.html*"</span> <span class="token string">"https://jyywiki.cn/os-demos/introduction/logisim/"</span> --no-check-certificate
</pre></div></code-block><h4 id="mvV2GBzgftJRVrUWxiKGz2" class="wolai-block"><span class="inline-wrap">代码细节</span></h4><ol class="wolai-block"><li id="kUarb5EaLXukXPvaeCjf2L"><div class="marker"></div><span class="inline-wrap">通过<span class="jill"></span>C<span class="jill"></span>语言来抽象电路的思想</span><code-block id="x8D5aQF8yKER8xazcH3xVJ" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token comment">// Wires</span>
<span class="token comment">// A wire in digital circuits is used to connect different components</span>
<span class="token comment">// together, allowing the transmission of electrical signals between them.</span>
<span class="token comment">// A wire is represented as a boolean value (true or false), which</span>
<span class="token comment">// corresponds to high (1) and low (0) voltage levels in a real circuit.</span>
<span class="token keyword">typedef</span> bool wire<span class="token punctuation">;</span>

<span class="token comment">// Flip-flops</span>
<span class="token comment">// A basic memory element in digital circuits, capable of storing one bit</span>
<span class="token comment">// of data. It has an input and an output (wires), and it maintains its</span>
<span class="token comment">// output value until the input changes and a clock signal is received.</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    bool value<span class="token punctuation">;</span> <span class="token comment">// The current value stored in the flip-flop</span>
    wire <span class="token operator">*</span>in<span class="token punctuation">;</span>   <span class="token comment">// Pointer to the input wire</span>
    wire <span class="token operator">*</span>out<span class="token punctuation">;</span>  <span class="token comment">// Pointer to the output wire</span>
<span class="token punctuation">}</span> reg<span class="token punctuation">;</span>

<span class="token comment">// Logical gates from NAND</span>
<span class="token comment">// NAND gate is a fundamental building block in digital electronics. Using</span>
<span class="token comment">// NAND gates, one can construct any other logical operation.</span>

<span class="token comment">// NAND gate: Returns true unless both inputs are true.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NAND</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token comment">// 可以由NAND构成所有的逻辑电路</span></span>

<span class="token comment">// NOT gate: Inverts the input.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NOT</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">NAND</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// AND gate: Returns true only if both inputs are true.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">AND</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">NOT</span><span class="token punctuation">(</span><span class="token function">NAND</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// OR gate: Returns true if at least one input is true.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">OR</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">NAND</span><span class="token punctuation">(</span><span class="token function">NOT</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NOT</span><span class="token punctuation">(</span>Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// Clock cycles</span>
<span class="token comment">// In digital circuits, a clock signal is used to synchronize operations.</span>
<span class="token comment">// This infinite loop mimicks the continuous nature of a clock signal in</span>
<span class="token comment">// a real circuit. We assume that all flip-flops are updated simultaneously</span>
<span class="token comment">// on the end of a cycle.</span>
<span class="token comment">/* 这个无限循环模拟了真实电路中时钟信号的连续性。我们假定在一个周期结束时，所有的触发器会同时更新。
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLOCK_CYCLE</span> <span class="token expression"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
</pre></div></code-block><ol class="wolai-block"><li id="aXQV7ycNVCrvggkH3ynQmE"><div class="marker"></div><span class="inline-wrap"><b>导线：用布尔型<span class="jill"></span>bool<span class="jill"></span>抽象<span class="jill"></span>Verilog<span class="jill"></span>中的<span class="jill"></span>wire</b></span></li><li id="3746DyYgDPNKW1ap3vBGjg"><div class="marker"></div><span class="inline-wrap"><b>时钟：while(1)循环进行抽象<span class="jill"></span>Verilog<span class="jill"></span>中的<span class="jill"></span>clk</b></span></li><li id="kFixQ1MRipTeb2ZhvpYYHo"><div class="marker"></div><span class="inline-wrap"><b>逻辑门：定义宏，直接对导线进行操作</b></span><div id="nysDgC9dYXU1EvsVjCNVW6" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>通过<span class="jill"></span>NAND<span class="jill"></span>逻辑门可以构造其他任意的逻辑门</u></span></div></div></li><li id="vMGxYqHzrYDEPTeEFUJXK2"><div class="marker"></div><span class="inline-wrap"><b>寄存器：用包含三个成员的结构体抽象<span class="jill"></span>Verilog<span class="jill"></span>中的<span class="jill"></span>reg</b></span><div id="8VcV71QAUbh1gmwEyVueGq" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>这三个成员分别是寄存器所寄存的值，输入连接的值，输出连接的值——输入输出均使用指针变量</u></span></div></div></li></ol></li><li id="oZzmwU6epzBt8BQu6nHkTR"><div class="marker"></div><span class="inline-wrap">代码所表示的电路图以及真值表</span><div id="5Hr7xaMqhqo4bPxrkRearL" class="wolai-block"><figure class="wolai-left" style="width: 100%; flex-direction: column"><img src="media/image_1.png" style="width: 100%"/></figure></div></li><li id="cLqGcs5q8EGKi3oTw2xhvp"><div class="marker"></div><span class="inline-wrap">python<span class="jill"></span>中的</span><span class="inline-wrap"><a href="https://www.wolai.com/42gHqFb4WmUaADxUDLH5yt#42gHqFb4WmUaADxUDLH5yt" class="wolai-bi-link"><span class="embed-page">exec函数</span></a></span><div id="d9MPLJ6UU6KCM4V7vPBagV" class="wolai-block wolai-text"><div><span class="inline-wrap">在本项目中的使用方式是</span><span class="inline-wrap"><code>exec(line, (ctx := {}))</code></span><span class="inline-wrap">，使用到了</span><span class="inline-wrap"><b>海象运算符</b></span><span class="inline-wrap"><b><code>:</code></b></span><span class="inline-wrap"><code>=</code></span><span class="inline-wrap">，</span><span class="blue inline-wrap"><b>海象运算符可以实现赋值并返回，缩短代码行数，所赋值的变量作用域等同于代码所在位置</b></span><span class="inline-wrap">。而在这个例子中，</span><span class="green inline-wrap"><b>通过</b></span><span class="green inline-wrap"><b><code>(ctx := {})</code></b></span><span class="green inline-wrap"><b>创建的字典作为全局命名空间，代码</b></span><span class="green inline-wrap"><b><code>line</code></b></span><span class="green inline-wrap"><b>在这个全局命名空间中执行，并且变量</b></span><span class="green inline-wrap"><b><code>ctx</code></b></span><span class="green inline-wrap"><b>也可以在后续的代码中用于访问和处理这个全局命名空间中的内容（每次执行时都先初始化为空）</b></span><span class="inline-wrap">。例如，如果</span><span class="inline-wrap"><code>line</code></span><span class="inline-wrap">是一段代码，它在执行过程中定义了新的变量，这些变量将会存储在</span><span class="inline-wrap"><code>ctx</code></span><span class="inline-wrap">这个字典中</span></div></div><div id="kJXHt85E1SZUp8qtPt2ueu" class="wolai-block wolai-text"><div><span class="green inline-wrap"><b>如果不使用海象运算符，那么需要分两行代码</b></span><span class="inline-wrap">。但是这样可以保存所有<span class="jill"></span>line<span class="jill"></span>的执行结果。而不是每次都重新从一个空字典中保存</span></div></div><code-block id="5f248bRQgTEfZCrKZup91F" class="wolai-block"><div class="wolai-pre"><div data-lang="Python" class="marker"></div><pre>ctx <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">exec</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span>ctx<span class="token punctuation">)</span></pre></div></code-block></li><li id="bzHQjaJbX5XvsNXmjAbCrH"><div class="marker"></div><span class="inline-wrap">终端颜色控制<span class="jill"></span>+<span class="jill"></span>清屏<span class="jill"></span>+<span class="jill"></span>设置光标</span><div id="ko934njiCPPvQySeiX1Th1" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://www.wolai.com/eCpjfL23GsBYwVDHxN7cu3#eCpjfL23GsBYwVDHxN7cu3" class="wolai-bi-link"><span class="embed-page">终端输出颜色控制</span></a></span></div></div><div id="jZE98NxnbgrhPUrY9sdesn" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>\033[2J</code></span><span class="inline-wrap">清屏</span></div></div><div id="sAj6roecRuB6Wd4YppFF92" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>\033[1;1f </code></span><span class="inline-wrap">设置光标在左上角</span></div></div><div id="25vsSX5dHMdE6tKoC3PtNd" class="wolai-block wolai-text"><div><span class="inline-wrap"><code>░</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>█</code></span><span class="inline-wrap">色块的使用</span></div></div></li></ol><h3 id="mt7GdmpWLdDLvGmLLfR29D" class="wolai-block"><span class="inline-wrap">软件——mini-rv32ima</span></h3><code-block id="42fTeYjiieduKSf4c4u9xj" class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">wget</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-np</span> <span class="token parameter variable">-nH</span> --cut-dirs<span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-R</span> <span class="token string">"index.html*"</span> <span class="token string">"https://jyywiki.cn/os-demos/introduction/mini-rv32ima/"</span> --no-check-certificate</pre></div></code-block><div id="rpvEEugiaZqjMps3QYdnQT" class="wolai-block wolai-text"><div><span class="inline-wrap">要我自己写，肯定写不出来，但是还是很容易看懂的</span></div></div><h4 id="iKhN3uUxneCdS4HxcU5UP" class="wolai-block"><span class="inline-wrap"><b>main.c</b></span></h4><ul class="wolai-block"><li id="2tWn3hJofoQRUkL8PuYTmj"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>宏定义</b></span><code-block id="mZz8KXkZbTCspht2xdXmt7" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAM_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">// Just default RAM amount is 64MB.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAM_TEXT_START</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAM_TEXT_END</span> <span class="token expression">RAM_STACK_START</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAM_STACK_START</span> <span class="token expression"><span class="token punctuation">(</span>RAM_SIZE <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> </span><span class="token comment">// 栈大小为32MB　代码最大也是32MB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAM_STACK_END</span> <span class="token expression">RAM_SIZE </span><span class="token comment">// 栈初始位置</span></span></pre></div></code-block><div id="7wGXcph6732W1oHDDomdSw" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>定义了<span class="jill"></span>RAM<span class="jill"></span>的大小为<span class="jill"></span>64MB，并将<span class="jill"></span>RAM<span class="jill"></span>中的内容分为两部分：代码段<span class="jill"></span>+<span class="jill"></span>栈段。每段均为<span class="jill"></span>32MB</u></span></div></div></li><li id="uJrXsC24HysYnsNSvzaLB8"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>void DumpState(struct CPUState *core)</code></span><span class="inline-wrap">打印当前的<span class="jill"></span>CPU<span class="jill"></span>状态（</span><span class="green inline-wrap"><b>PC+<span class="jill"></span>全部寄存器<span class="jill"></span>+CSR<span class="jill"></span>中的<span class="jill"></span>CYCLEL、CYCLEH、EXTRAFLAGS+<span class="jill"></span>栈内容</b></span><span class="inline-wrap">）</span><code-block id="aJhzBQZccHNmCvZUzQi6Fb" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token keyword">struct</span> <span class="token class-name">CPUState</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Processor internal state</span>
    <span class="token class-name">uint32_t</span> regs<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> csrs<span class="token punctuation">[</span>CSR_COUNT<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//枚举按次序从0增加，因此CSR_COUNT恰好为之前的CSR数量</span>

    <span class="token comment">// Memory state</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span>mem<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> mem_offset<span class="token punctuation">,</span> mem_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DumpState</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">CPUState</span> <span class="token operator">*</span>core<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint32_t</span> pc <span class="token operator">=</span> core<span class="token operator">-></span>csrs<span class="token punctuation">[</span>PC<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> pc_offset <span class="token operator">=</span> pc <span class="token operator">-</span> RAM_TEXT_START<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> ir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" PC:%08x"</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pc_offset <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pc_offset <span class="token operator">&lt;</span> RAM_TEXT_END <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 4B一个指令长度</span>
    <span class="token punctuation">{</span>
        ir <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>core<span class="token operator">-></span>mem<span class="token punctuation">)</span><span class="token punctuation">[</span>pc_offset<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" [%08x]"</span><span class="token punctuation">,</span> ir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token comment">// 否则指令PC越界</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" [xxxxxxxx]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> <span class="token operator">*</span>regs <span class="token operator">=</span> core<span class="token operator">-></span>regs<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  Z:%08x  ra:%08x  sp:%08x  gp:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>Z<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>RA<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>SP<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>GP<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" tp:%08x  t0:%08x  t1:%08x  t2:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>TP<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T0<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" s0:%08x  s1:%08x  a0:%08x  a1:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S0<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S1<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A0<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" a2:%08x  a3:%08x  a4:%08x  a5:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A2<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A3<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A4<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A5<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" a6:%08x  a7:%08x  s2:%08x  s3:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A6<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>A7<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S2<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" s4:%08x  s5:%08x  s6:%08x  s7:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S4<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S5<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S6<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S7<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" s8:%08x  s9:%08x s10:%08x s11:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S8<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S9<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S10<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>S11<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" t3:%08x  t4:%08x  t5:%08x  t6:%08x\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T3<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T4<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T5<span class="token punctuation">]</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span>T6<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> <span class="token operator">*</span>csrs <span class="token operator">=</span> core<span class="token operator">-></span>csrs<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CYCLEL:%08x CYCLEH:%08x EXTRAFLAGS:%08x\n"</span><span class="token punctuation">,</span> csrs<span class="token punctuation">[</span>CYCLEL<span class="token punctuation">]</span><span class="token punctuation">,</span> csrs<span class="token punctuation">[</span>CYCLEH<span class="token punctuation">]</span><span class="token punctuation">,</span> csrs<span class="token punctuation">[</span>EXTRAFLAGS<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stack (sp:%08x):\n"</span><span class="token punctuation">,</span> regs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> sp <span class="token operator">=</span> regs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> sp <span class="token operator">&lt;</span> core<span class="token operator">-></span>mem_size<span class="token punctuation">;</span> sp <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 打印栈内容</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%08x: %08x\n"</span><span class="token punctuation">,</span> sp<span class="token punctuation">,</span> core<span class="token operator">-></span>mem<span class="token punctuation">[</span>sp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%#08x\n"</span><span class="token punctuation">,</span> RAM_STACK_END<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block></li><li id="pPKvkcM5dR4SWxSKRDRGoo"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>int xtoi(char *s)</code></span><span class="inline-wrap">十六进制转十进制</span><code-block id="x5B7jBdGNncTQE4G3osdrv" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token keyword">int</span> <span class="token function">xtoi</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token comment">// 十六进制转十进制</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">// 0x------ 从高位开始转换</span>
    <span class="token punctuation">{</span>
        res <span class="token operator">*=</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">// (res+多少)*16</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token char">'f'</span><span class="token punctuation">)</span>
            res <span class="token operator">+=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token char">'a'</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> 
            res <span class="token operator">+=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token char">'0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><div id="3cpmGLePe5LpazLZ5N3Jzb" class="wolai-block wolai-text"><div><span class="inline-wrap">首先，因为需要去掉字符串中“0x”，所以<span class="jill"></span>i<span class="jill"></span>从<span class="jill"></span>2<span class="jill"></span>开始到空字符</span></div></div><div id="cqT7cNed5bqxh3VPKSLbii" class="wolai-block wolai-text"><div><span class="inline-wrap">然后，采用的是从高位到低位的转换思想，每一位都先乘以<span class="jill"></span>16<span class="jill"></span>再加上这位代表的数值</span></div></div></li><li id="tdkUytgqnyTzM7eQMgdD9V"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>int main(int argc, char **argv)</code></span><ol class="wolai-block"><li id="yg63W2wz7YAb3xibTCUPz"><div class="marker"></div><span class="inline-wrap">首先，main<span class="jill"></span>函数的执行至少需要两个参数（</span><span class="green inline-wrap"><u>argv[0]是当前脚本名称，argv[1]是指定的可执行文件名称</u></span><span class="inline-wrap">）</span><code-block id="gKGmq2jsheSHY2qTc6VQ9W" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token comment">// get the testcase</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: ./mini-rv32ima &lt;path_testcase> &lt;arg1> &lt;arg2> ... &lt;argn>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- The testcase file should be a rv32i binary with 0 offset to the first line of instruction.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"- Note that we only support dec/hex int-type mainargs for simplicity.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></pre></div></code-block></li><li id="8YsHzoq8irWz8NZ7ZGecRC"><div class="marker"></div><span class="inline-wrap">然后，从第一个参数中获取<span class="jill"></span>mini-rv32ima<span class="jill"></span>所要执行的可执行文件名称</span><code-block id="vTm8UbJj5MRPqDRonh2f1i" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>image_filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[mini-rv32ima] load image file: %s\n"</span><span class="token punctuation">,</span> image_filename<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></li><li id="ayt9K7Uevhk7cqw2TWwVgr"><div class="marker"></div><span class="inline-wrap">接着，初始化<span class="jill"></span>CPUState<span class="jill"></span>变量，并设置<span class="jill"></span>mem<span class="jill"></span>相关变量以及<span class="jill"></span>PC<span class="jill"></span>的初始值</span><ol class="wolai-block"><li id="rSRhmZ47622uT9incjzFto"><div class="marker"></div><span class="inline-wrap">CPUState<span class="jill"></span>内变量都初始化为<span class="jill"></span>0</span></li><li id="peuApfLz2Eu2cyDDzJZtt7"><div class="marker"></div><span class="inline-wrap">为<span class="jill"></span>mem<span class="jill"></span>指针分配<span class="jill"></span>RAM_SIZE<span class="jill"></span>字节大小空间，并初始化为<span class="jill"></span>0</span></li><li id="VEqGe3pRqB8T6jJ8kxmME"><div class="marker"></div><span class="inline-wrap">初始化<span class="jill"></span>mem_offset、mem_size<span class="jill"></span>以及<span class="jill"></span>PC</span></li></ol><code-block id="kx8e99pBLMfyCxxScKx1s6" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token comment">// allocate ram image</span>
    <span class="token keyword">struct</span> <span class="token class-name">CPUState</span> state<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[mini-rv32ima] alloc ram size = %#x\n"</span><span class="token punctuation">,</span> RAM_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>mem <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>RAM_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>mem<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: failed to allocate ram image.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>mem_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>mem_offset <span class="token operator">=</span> RAM_TEXT_START<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>mem_size <span class="token operator">=</span> RAM_SIZE<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>csrs<span class="token punctuation">[</span>PC<span class="token punctuation">]</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>mem_offset<span class="token punctuation">;</span></pre></div></code-block></li><li id="pYSQxxnVSWHkmo7cheAcW2"><div class="marker"></div><span class="inline-wrap">读取指定的可执行文件的指令序列</span><span class="inline-wrap"><code>flen</code></span><span class="inline-wrap">字节内容到</span><span class="inline-wrap"><code>state.mem + RAM_TEXT_START</code></span><code-block id="wcsvMqE9vELyM7wo4kNLQN" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token comment">// load insts from testcase</span>
    FILE <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>image_filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f <span class="token operator">||</span> <span class="token function">ferror</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: image file \"%s\" not found\n"</span><span class="token punctuation">,</span> image_filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fseek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> flen <span class="token operator">=</span> <span class="token function">ftell</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得文件大小</span>
    <span class="token function">fseek</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flen <span class="token operator">></span> RAM_TEXT_END <span class="token operator">-</span> RAM_TEXT_START<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: image file size too big (%#lx bytes)\n"</span><span class="token punctuation">,</span> flen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>mem <span class="token operator">+</span> RAM_TEXT_START<span class="token punctuation">,</span> flen<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Failed to load image file\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></li><li id="29PWgHgzfs5MU1vS1xfrBg"><div class="marker"></div><span class="inline-wrap">获得可执行文件参数，最多<span class="jill"></span>4<span class="jill"></span>个</span><div id="9ynJCX5ZJMmbQnRoSKqMBy" class="wolai-block wolai-text"><div><span class="inline-wrap">首先，将运行命令中的参数获取出来，存储到<span class="jill"></span>margs<span class="jill"></span>中</span></div></div><code-block id="3dvbHqnakDT6WP2TphchyB" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MAINARGS</span> <span class="token expression"><span class="token number">4</span></span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">></span> <span class="token number">2</span> <span class="token operator">+</span> MAX_MAINARGS<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[mini-rv32ima] WARN: mainargs should &lt;= %d, the excess ones will be discarded\n"</span><span class="token punctuation">,</span> MAX_MAINARGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> margc <span class="token operator">=</span> <span class="token punctuation">(</span>argc <span class="token operator">></span> <span class="token number">2</span> <span class="token operator">+</span> MAX_MAINARGS <span class="token operator">?</span> MAX_MAINARGS <span class="token operator">:</span> argc <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前两个参数是指定运行文件和image文件</span>
    <span class="token keyword">int</span> margs<span class="token punctuation">[</span>MAX_MAINARGS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[mini-rv32ima] mainargs:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> margc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'0'</span> <span class="token operator">&amp;&amp;</span> argv<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'x'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            margs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xtoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            margs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s - %d\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">,</span> margs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></pre></div></code-block><div id="o7KxM1M98gPW1p1LLrDUaB" class="wolai-block wolai-text"><div><span class="inline-wrap">然后，将这些参数保存到堆栈中</span></div><div id="7ygJFuKm561pcQBFN41r4k" class="wolai-block wolai-text"><div><span class="inline-wrap">栈是向下的，因此栈指针应该设置为</span><span class="inline-wrap"><code>RAM_STACK_END - margc * sizeof(int32_t)</code></span></div></div><div id="oZrfmEGB4bpLMkRmLpfAfU" class="wolai-block wolai-text"><div><span class="inline-wrap">然后，将栈指针保存到<span class="jill"></span>sp<span class="jill"></span>寄存器中，并设置参数值到寄存器中（为什么既要保存到<span class="jill"></span>SP<span class="jill"></span>又要保存到<span class="jill"></span>A1）</span></div></div></div><code-block id="hqJUCpZspsukRysU3sbZvr" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token class-name">uint32_t</span> sp <span class="token operator">=</span> RAM_STACK_END <span class="token operator">-</span> margc <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>mem <span class="token operator">+</span> sp<span class="token punctuation">,</span> margs<span class="token punctuation">,</span> RAM_STACK_END <span class="token operator">-</span> sp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将参数存储在栈中 memcpy的len应该是字节 这里也可以替换成margc * sizeof(int32_t)</span>
    state<span class="token punctuation">.</span>regs<span class="token punctuation">[</span>SP<span class="token punctuation">]</span> <span class="token operator">=</span> sp<span class="token punctuation">;</span> <span class="token comment">//传递栈指针</span>
    state<span class="token punctuation">.</span>regs<span class="token punctuation">[</span>A0<span class="token punctuation">]</span> <span class="token operator">=</span> margc<span class="token punctuation">;</span> <span class="token comment">// 传参 A0指定个数 A1指定栈指针</span>
    state<span class="token punctuation">.</span>regs<span class="token punctuation">[</span>A1<span class="token punctuation">]</span> <span class="token operator">=</span> sp<span class="token punctuation">;</span> </pre></div></code-block></li><li id="iAAG5tYZR6dMHqi8sEwM9L"><div class="marker"></div><span class="inline-wrap">执行指令序列</span><code-block id="gN4w9sA8CwPZuT1W9yL1k6" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token comment">// do emulation</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"initially:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DumpState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印初始状态</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">int</span> debug_climit <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> <span class="token comment">// 手动设置最多可执行时钟限制,防止死循环</span>
    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">rv32ima_step</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mini-rv32ima.h中定义的内联函数——核心函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"minirv32ima ret=%d !=0\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// DumpState(&amp;state);</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>debug_climit <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: debug_climit exceed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>csrs<span class="token punctuation">[</span>PC<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当ret不为0或者PC为0时结束循环</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"finally:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DumpState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></li></ol></li></ul><h4 id="hL9ygLzUD7hkbBFMieugsF" class="wolai-block"><span class="inline-wrap"><b>mini-rv32ima.h</b></span></h4><ol class="wolai-block"><li id="73rj2gHz63nqVgbTCeYcT9"><div class="marker"></div><span class="inline-wrap">定义通用寄存器的汇编名称（与通用名称、ABI<span class="jill"></span>约定的索引位置一一对应）</span><code-block id="yLsLGXowEfMVof4zbwTFh" class="wolai-block"><div class="wolai-pre"><div data-lang="6502 Assembly" class="marker"></div><pre><span class="token comment">// riscv32 寄存器定义通用名称和汇编名称</span>
<span class="token keyword">enum</span> <span class="token constant">RV32IMA_REG</span>
<span class="token punctuation">{</span>
    <span class="token constant">Z</span><span class="token punctuation">,</span> <span class="token comment">// x0: Zero Register.</span>
       <span class="token comment">//     Always wired to 0 and ignores writes.</span>
    <span class="token constant">RA</span><span class="token punctuation">,</span> <span class="token comment">// x1: Return Address.</span>
        <span class="token comment">//     Used by convention to store the return address in function</span>
        <span class="token comment">//     calls. jal and jalr store the address to return.</span>
    <span class="token constant">SP</span><span class="token punctuation">,</span> <span class="token comment">// x2: Stack Pointer.</span>
        <span class="token comment">//     Points to the top of the stack in memory.</span>
    <span class="token constant">GP</span><span class="token punctuation">,</span> <span class="token comment">// x3: Global Pointer.</span>
        <span class="token comment">//     Typically points to the middle of the global data segment.</span>
    <span class="token constant">TP</span><span class="token punctuation">,</span> <span class="token comment">// x4: Thread Pointer.</span>
        <span class="token comment">//     Used for thread-local storage.</span>
    <span class="token constant">T0</span><span class="token punctuation">,</span> <span class="token comment">// x5-x7: Temporary Registers.</span>
    <span class="token constant">T1</span><span class="token punctuation">,</span> <span class="token comment">//     Temporary storage by assembly code and compilers. Do not need</span>
    <span class="token constant">T2</span><span class="token punctuation">,</span> <span class="token comment">//     to be preserved across function calls.</span>
    <span class="token constant">S0</span><span class="token punctuation">,</span> <span class="token comment">// x8-x9: Saved Registers.</span>
    <span class="token constant">S1</span><span class="token punctuation">,</span> <span class="token comment">//     Store values that should be preserved across function calls.</span>
        <span class="token comment">//     S0 is also known as FP (Frame Pointer) in some calling</span>
        <span class="token comment">//     conventions.</span>
    <span class="token constant">A0</span><span class="token punctuation">,</span> <span class="token comment">// x10-x17: Argument Registers.</span>
    <span class="token constant">A1</span><span class="token punctuation">,</span> <span class="token comment">//     Eight arguments to functions.</span>
    <span class="token constant">A2</span><span class="token punctuation">,</span> <span class="token comment">//     A0 and A1 are also used to return values from functions</span>
    <span class="token constant">A3</span><span class="token punctuation">,</span>
    <span class="token constant">A4</span><span class="token punctuation">,</span>
    <span class="token constant">A5</span><span class="token punctuation">,</span>
    <span class="token constant">A6</span><span class="token punctuation">,</span>
    <span class="token constant">A7</span><span class="token punctuation">,</span>
    <span class="token constant">S2</span><span class="token punctuation">,</span> <span class="token comment">// x18-x27: More Saved Registers.</span>
    <span class="token constant">S3</span><span class="token punctuation">,</span> <span class="token comment">//     Like S0 and S1, these registers are used to store values that</span>
    <span class="token constant">S4</span><span class="token punctuation">,</span> <span class="token comment">//     need to be preserved across function calls</span>
    <span class="token constant">S5</span><span class="token punctuation">,</span>
    <span class="token constant">S6</span><span class="token punctuation">,</span>
    <span class="token constant">S7</span><span class="token punctuation">,</span>
    <span class="token constant">S8</span><span class="token punctuation">,</span>
    <span class="token constant">S9</span><span class="token punctuation">,</span>
    <span class="token constant">S10</span><span class="token punctuation">,</span>
    <span class="token constant">S11</span><span class="token punctuation">,</span>
    <span class="token constant">T3</span><span class="token punctuation">,</span> <span class="token comment">// x28-x31: More Temporary Registers.</span>
    <span class="token constant">T4</span><span class="token punctuation">,</span> <span class="token comment">//     Like T0-T2, their values do not need to be preserved across</span>
    <span class="token constant">T5</span><span class="token punctuation">,</span> <span class="token comment">//     function calls</span>
    <span class="token constant">T6</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></pre></div></code-block></li><li id="boR4sJzrCEm7LNxGe7LH1a"><div class="marker"></div><span class="inline-wrap">定义<span class="jill"></span>CSR<span class="jill"></span>的名称，这里把<span class="jill"></span>PC<span class="jill"></span>也作为<span class="jill"></span>CSR</span><div id="8SKm8maoLWCUj5UQYtaC4F" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>利用枚举变量默认从<span class="jill"></span>0<span class="jill"></span>递增的特点，最后的<span class="jill"></span>CSR_COUNT<span class="jill"></span>恰为所定义的<span class="jill"></span>CSR<span class="jill"></span>个数</u></span><span class="inline-wrap">。</span><span class="green inline-wrap"><u>这里把<span class="jill"></span>PC<span class="jill"></span>也作为了一个<span class="jill"></span>CSR，且加入了<span class="jill"></span>ABI<span class="jill"></span>中没有的<span class="jill"></span>EXTRAFLAGS<span class="jill"></span>和拆分的<span class="jill"></span>MIE</u></span></div></div><code-block id="hcjBkdBW3HPXJ1cjcdfHxE" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token comment">// riscv32 CSR</span>
<span class="token comment">// 把PC也作为了一个CSR</span>
<span class="token keyword">enum</span> <span class="token class-name">RV32IMA_CSR</span>
<span class="token punctuation">{</span>
    PC<span class="token punctuation">,</span>          <span class="token comment">// Program Counter: Address of the current instruction</span>
    MSTATUS<span class="token punctuation">,</span>     <span class="token comment">// Machine Status Register: Global interrupt enable,</span>
                 <span class="token comment">// previous privilege mode, and other status bits</span>
    CYCLEL<span class="token punctuation">,</span>      <span class="token comment">// Cycle Counter Low: Lower 32 bits of the cycle counter;</span>
                 <span class="token comment">// counts the number of cycles since reset</span>
    CYCLEH<span class="token punctuation">,</span>      <span class="token comment">// Cycle Counter High: Upper 32 bits of the cycle counter</span>
    TIMERL<span class="token punctuation">,</span>      <span class="token comment">// Timer Low: Lower 32 bits of the real-time counter;</span>
                 <span class="token comment">// increments at a constant rate</span>
    TIMERH<span class="token punctuation">,</span>      <span class="token comment">// Timer High: Upper 32 bits of the real-time counter</span>
    TIMERMATCHL<span class="token punctuation">,</span> <span class="token comment">// Timer Match Low: Lower 32 bits of the timer match register</span>
                 <span class="token comment">// for setting timer interrupts</span>
    TIMERMATCHH<span class="token punctuation">,</span> <span class="token comment">// Timer Match High: Upper 32 bits of the timer match register</span>
    MSCRATCH<span class="token punctuation">,</span>    <span class="token comment">// Machine Scratch: Scratch register for trap handler</span>
    MTVEC<span class="token punctuation">,</span>       <span class="token comment">// Machine Trap-Vector Base-Address Register: Base address of</span>
                 <span class="token comment">// the trap vector</span>
    MIE<span class="token punctuation">,</span>         <span class="token comment">// 拆分了mstatus Machine Interrupt Enable: Which interrupts are enabled</span>
    MIP<span class="token punctuation">,</span>         <span class="token comment">// Machine Interrupt Pending: Which interrupts are pending</span>
    MEPC<span class="token punctuation">,</span>        <span class="token comment">// Machine Exception PC: Address to return to after exception</span>
    MTVAL<span class="token punctuation">,</span>       <span class="token comment">// Machine Trap Value: Additional information about the trap</span>
    MCAUSE<span class="token punctuation">,</span>      <span class="token comment">// Machine Cause Register: The cause of the last trap</span>
    EXTRAFLAGS<span class="token punctuation">,</span>  <span class="token comment">// Extra Flags: Processor internal decode states</span>
                 <span class="token comment">// (not part of the standard RISC-V specification)</span>

    CSR_COUNT<span class="token punctuation">,</span> <span class="token comment">// Number of CSRs: Utility value; the number of CSRs</span>
               <span class="token comment">// (Comments above are generated by GPT)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre></div></code-block><ul class="wolai-block"><li id="btQN4zgP58qn3dbRELMZwR"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">TIMERMATCHH/L</span><div id="fTPUt6eu7mddeCsCwJHDkE" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u><code>TIMERMATCHH/L</code></u></span><span class="green inline-wrap"><u>通常与定时器功能相关。它主要用于存储定时器匹配值，当定时器计数值大于</u></span><span class="green inline-wrap"><u><code>TIMERMATCHH/L</code></u></span><span class="green inline-wrap"><u>中存储的值时，会触发相应的中断</u></span></div></div></li><li id="NjrUtpvpwFzQCxFKKanX8"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="green inline-wrap"><u>MIE：对应于<span class="jill"></span>MIP<span class="jill"></span>的局部中断使能</u></span></li><li id="jBJg9sGKV53eCVNztwmhCX"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">MIP</span><div id="j5wHd6PbNq8htaQzQzfeqS" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>MIP<span class="jill"></span>用于指示机器模式下正在等待处理的中断，每一位通常都对应一个中断/异常事件</u></span></div><div id="sjJjxLAkvN8V8CYuRBEF76" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>第<span class="jill"></span>8<span class="jill"></span>位：时钟中断</u></span></div></div></div></li><li id="uNhdChdpnjKR9qqkBBCebr"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">MTVAL：关于<span class="jill"></span>Trap<span class="jill"></span>的附加信息</span></li><li id="aaQ3PKFuQRAiTY3wAUkDkz"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">EXTRAFLAGS</span><div id="t1ts5bCjumfD4rW7zncVom" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>1...0：表示当前机器模式，3<span class="jill"></span>是<span class="jill"></span>USER，0<span class="jill"></span>是<span class="jill"></span>KERNEL</u></span></div></div><div id="v8KN6WTUfgKHkQ5fWQPAx" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>2：WFI，当处理器执行到设置了 WFI 位的指令时，处理器会进入一种低功耗等待状态，直到触发中断后，才将其置为<span class="jill"></span>0</u></span></div></div><div id="b4sWP4gjGZv2daGCHoqTFR" class="wolai-block wolai-text"><div><span class="inline-wrap">3+：Load/Store reservation LSBs.</span></div></div></li></ul></li><li id="27fJD5tt4h3NnUpqSVbVou"><div class="marker"></div><span class="inline-wrap">CPU_state<span class="jill"></span>结构体，之前已提及</span></li><li id="fTKQ6beCY72LxapPWegyvM"><div class="marker"></div><span class="inline-wrap"><code>static inline int32_t rv32ima_step(struct CPUState *state, uint32_t elapsedUs)</code></span><ul class="wolai-block"><li id="szijHw8E8pu5Z8k1WAG3Xq"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>参数解析</b></span><div id="hYrgT63WvmhhNVowUteGTv" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>state<span class="jill"></span>是<span class="jill"></span>main.c<span class="jill"></span>中创建的<span class="jill"></span>CPU_state<span class="jill"></span>结构体指针</u></span></div></div><div id="eK2LXFNkenhbFLVbVsKAdr" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>elapsedUS<span class="jill"></span>在<span class="jill"></span>main.c<span class="jill"></span>中设置为<span class="jill"></span>1，表示执行一条指令过去的时间，用于更改时钟<span class="jill"></span>CSR</u></span></div></div></li><li id="byuwqhreVEMjJXtAdMpky4"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>读<span class="jill"></span>GR、CSR、MEM<span class="jill"></span>的宏定义</b></span><code-block id="nR3H91RUByLr7wzuaZVZtz" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CSR</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span>state<span class="token operator">-></span>csrs<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REG</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span>state<span class="token operator">-></span>regs<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MEM</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>state<span class="token operator">-></span>mem<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> </span><span class="token comment">// MEM是读的对应mem的x单元的地址</span></span></pre></div></code-block></li><li id="3xuRT89h4zAKrATTE9FdrG"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>根据<span class="jill"></span>elapsedUS<span class="jill"></span>调整时钟<span class="jill"></span>CSR</b></span><div id="p54YDfuMmdmZyw4d1b5riW" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>64<span class="jill"></span>位计数器分高<span class="jill"></span>32<span class="jill"></span>位和低<span class="jill"></span>32<span class="jill"></span>位，分别存储在<span class="jill"></span>TIMERH<span class="jill"></span>和<span class="jill"></span>TIMERL<span class="jill"></span>中。因此对<span class="jill"></span>TIMERL<span class="jill"></span>的递增需要考虑溢出——当前值加<span class="jill"></span>1<span class="jill"></span>小于当前值，然后递增<span class="jill"></span>TIMERH</u></span></div></div><code-block id="2DVLNuDgTgeoUPcaNGEaij" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token comment">// 对定时器CSR进行调整</span>
    <span class="token class-name">uint32_t</span> new_timer <span class="token operator">=</span> <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERL<span class="token punctuation">)</span> <span class="token operator">+</span> elapsedUs<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_timer <span class="token operator">&lt;</span> <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 发生了溢出</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERH<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERL<span class="token punctuation">)</span> <span class="token operator">=</span> new_timer<span class="token punctuation">;</span></pre></div></code-block></li><li id="72ZLJ9JopimV1MLxqqVhfi"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>检测时钟中断是否发生并处理</b></span><code-block id="wG3XeHdvmV6N5PYPHu6hvB" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token comment">// Handle Timer interrupt.</span>

    <span class="token class-name">uint64_t</span> timer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token function">CSR</span><span class="token punctuation">(</span>TIMERH<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint64_t</span> timermatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token punctuation">)</span><span class="token function">CSR</span><span class="token punctuation">(</span>TIMERMATCHH<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERMATCHL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// timer macth reg是用来触发时钟中断的</span>

    <span class="token comment">// 对TIMERMATCH设置了有效值以后才能进行时钟中断 当timer>timermatch时触发中断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>TIMERMATCHH<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">CSR</span><span class="token punctuation">(</span>TIMERMATCHL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timer <span class="token operator">></span> timermatch<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>EXTRAFLAGS<span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// EXTRAFLAGS的第三位表示等待中断状态,发生中断则需要将该位置0</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>MIP<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>    <span class="token comment">// mip的第八位表示时钟中断，置１发起中断请求</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>MIP<span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 没有时钟中断</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If WFI (waiting for interrupt), don't run processor.</span>
    <span class="token comment">// Note: only a few bits are used.  (Machine = 3, User = 0)</span>
    <span class="token comment">// Bits 0..1 = privilege.</span>
    <span class="token comment">// Bit 2 = WFI (Wait for interrupt)</span>
    <span class="token comment">// Bit 3+ = Load/Store reservation LSBs.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>EXTRAFLAGS<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 如果WFI仍有效,那么停止处理器的运行</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></div></code-block><code-block id="a32igzu5BVaZS4dxMFyzGZ" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token class-name">uint32_t</span> trap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//NO</span>
    <span class="token class-name">uint32_t</span> rval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//操作返回值</span>
    <span class="token class-name">uint32_t</span> pc <span class="token operator">=</span> <span class="token function">CSR</span><span class="token punctuation">(</span>PC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当前PC</span>
    <span class="token class-name">uint32_t</span> cycle <span class="token operator">=</span> <span class="token function">CSR</span><span class="token punctuation">(</span>CYCLEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当前的时钟周期</span>

    <span class="token comment">// Timer interrupt. mstatus全局中断使能　mie局部使能　且有时钟中断　</span>
    <span class="token comment">// trap</span>
    <span class="token comment">//    1:code 0,PC-misaligned PC非对齐异常 需要保存PC到mtval</span>
    <span class="token comment">//    2:code 1,access violation on instruction read 读指令越界异常 需要保存pc到mtval</span>
    <span class="token comment">//    3:code 2,指令opcode无效 需要保存PC到mtval</span>
    <span class="token comment">//    4:code 3,ebreak 断点</span>
    <span class="token comment">//    5:code 4,load地址未对齐 未实现</span>
    <span class="token comment">//    6:code 5,LOAD访存地址无效异常(可以访问CPU_state中的mem以及0x10000000~0x12000000的外设地址，目前只有定时器外设0x1100bffc 0x1100bff8),需要保存访存地址到mtval</span>
    <span class="token comment">//    7:code 6,store/AMO地址未对齐 未实现</span>
    <span class="token comment">//    8:code 7,STORE/AMO访存地址无效异常(可以访问CPU_state中的mem以及0x10000000~0x12000000的外设地址，目前只有时钟匹配寄存器 0x11004004 0x11004000和SYSCON 0x11100000) 需要保存访存地址到mtval</span>
    <span class="token comment">//    9:code 8,用户U模式下的系统调用</span>
    <span class="token comment">//   10:code 9,S模式下的系统调用 未实现</span>
    <span class="token comment">//   11:code 10,保留</span>
    <span class="token comment">//   12:code 11,机器M模式下的环境调用</span>
    <span class="token comment">//   5-6-7-8需要保存访存地址，其余保存pc</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>MIP<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>MIE<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token comment">/*mtie*/</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>MSTATUS<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x8</span> <span class="token comment">/*mie*/</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        trap <span class="token operator">=</span> <span class="token number">0x80000007</span><span class="token punctuation">;</span> <span class="token comment">// 陷入NO</span>
        pc <span class="token operator">-=</span> <span class="token number">4</span><span class="token punctuation">;</span>           <span class="token comment">// 返回pc</span>
        <span class="token keyword">goto</span> cycle_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></pre></div></code-block></li><li id="kZy4LCqGMHTf7V1vmvhHxr"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>cycle_end<span class="jill"></span>中断异常处理<span class="jill"></span>+<span class="jill"></span>设置时钟以及下一个<span class="jill"></span>PC</b></span><code-block id="hTNdtoqY3gECH8Zne8uLv9" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>cycle_end<span class="token operator">:</span>
    <span class="token comment">// Handle traps and interrupts.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trap<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trap <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token comment">// 是中断而不是陷入</span>
        <span class="token punctuation">{</span>                      <span class="token comment">// It's an interrupt, not a trap.</span>
            <span class="token function">CSR</span><span class="token punctuation">(</span>MCAUSE<span class="token punctuation">)</span> <span class="token operator">=</span> trap<span class="token punctuation">;</span>
            <span class="token function">CSR</span><span class="token punctuation">(</span>MTVAL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            pc <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// PC needs to point to where the PC will return to.　当前pc已经执行完成需要+4</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">CSR</span><span class="token punctuation">(</span>MCAUSE<span class="token punctuation">)</span> <span class="token operator">=</span> trap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">CSR</span><span class="token punctuation">(</span>MTVAL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>trap <span class="token operator">></span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> trap <span class="token operator">&lt;=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">?</span> rval <span class="token operator">:</span> pc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>MEPC<span class="token punctuation">)</span> <span class="token operator">=</span> pc<span class="token punctuation">;</span> <span class="token comment">// 返回pc</span>
        <span class="token comment">// On an interrupt, the system moves current MIE into MPIE</span>
        <span class="token comment">// mstatus的MIE到MPIE,没有禁止MIE说明支持多重中断　当前机器模式到ｍstatus的MPP</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>MSTATUS<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>MSTATUS<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>EXTRAFLAGS<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>MTVEC<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得中断服务程序地址</span>

        <span class="token comment">// If trapping, always enter machine mode.</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>EXTRAFLAGS<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 进入机器模式</span>

        trap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 恢复NO</span>
        pc <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// 可以上面不减4</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CSR</span><span class="token punctuation">(</span>CYCLEL<span class="token punctuation">)</span> <span class="token operator">></span> cycle<span class="token punctuation">)</span>
        <span class="token function">CSR</span><span class="token punctuation">(</span>CYCLEH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">CSR</span><span class="token punctuation">(</span>CYCLEH <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CSR</span><span class="token punctuation">(</span>CYCLEL<span class="token punctuation">)</span> <span class="token operator">=</span> cycle<span class="token punctuation">;</span>
    <span class="token function">CSR</span><span class="token punctuation">(</span>PC<span class="token punctuation">)</span> <span class="token operator">=</span> pc<span class="token punctuation">;</span></pre></div></code-block></li><li id="qWxzkLmcUatw3XhTxWVDaf"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>读取指令</b></span><div id="ouGnbcqTx758fLndc8ifR6" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>判断是否会触发指令访存越界或者指令非对齐异常，如果不触发那么读取指令字节码</u></span></div></div><code-block id="mYFXLLYya9D6UQzH4to4Mv" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>    <span class="token class-name">uint32_t</span> ir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//指令计算结果</span>
    cycle<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//递增时钟</span>
    <span class="token class-name">uint32_t</span> ofs_pc <span class="token operator">=</span> pc <span class="token operator">-</span> state<span class="token operator">-></span>mem_offset<span class="token punctuation">;</span> <span class="token comment">//获取pc到代码段起始的偏移</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs_pc <span class="token operator">>=</span> state<span class="token operator">-></span>mem_size<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">//大于了mem_size（说明指令取指可能会超过到堆栈区?),我改成了/2</span>
    <span class="token punctuation">{</span>
        trap <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Handle access violation on instruction read. 指令越界异常</span>
        <span class="token keyword">goto</span> cycle_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs_pc <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//4B对齐</span>
    <span class="token punctuation">{</span>
        trap <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Handle PC-misaligned access　指令非对齐异常</span>
        <span class="token keyword">goto</span> cycle_end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        ir <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">MEM</span><span class="token punctuation">(</span>ofs_pc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//读取指令</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    pc <span class="token operator">=</span> pc <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
</pre></div></code-block></li><li id="oQKK5gvHEBMawcBzempJwv"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>获取指令操作码，分类型执行</b></span><div id="hPHURZRWZyPKj8s3GgjoNm" class="wolai-block wolai-text"><div><span class="inline-wrap">指令操作码</span><span class="inline-wrap"><code>opcode=ir &amp; 07f</code></span><span class="inline-wrap">，目的寄存器</span><span class="inline-wrap"><code>rdid</code></span><span class="inline-wrap">是</span><span class="inline-wrap"><code>ir&gt;&gt;7 &amp; 01f</code></span></div></div><code-block id="3SPirJbxfHtJvQzXm1coXC" class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>        <span class="token class-name">uint32_t</span> rdid <span class="token operator">=</span> <span class="token punctuation">(</span>ir <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1f</span><span class="token punctuation">;</span> <span class="token comment">// 目的寄存器</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ir <span class="token operator">&amp;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token comment">// opcode</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0x37</span><span class="token operator">:</span> <span class="token comment">// LUI (0b0110111)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token number">0x17</span><span class="token operator">:</span> <span class="token comment">// AUIPC(0b0010111)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token number">0x6F</span><span class="token operator">:</span> <span class="token comment">// JAL(0b1101111)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token number">0x67</span><span class="token operator">:</span> <span class="token comment">//JALR(0b1100111)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token number">0x63</span><span class="token operator">:</span> <span class="token comment">//BRANCH(0b1100011)</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
           <span class="token comment">// 内部又会根据(ir>>12) &amp; 0x7值区分BRANCH指令</span>
           <span class="token comment">// 0-BEQ 1-BNE 4-BLT 5-BGE 6-BLTU 7-BGEU</span>
        <span class="token keyword">case</span> <span class="token number">0x03</span><span class="token operator">:</span> <span class="token comment">//LOAD(0b0000011)</span>
           <span class="token comment">// 分支处理读外设和读存储</span>
           <span class="token comment">// 读存储内部又会根据(ir>>12) &amp; 0x7值区分LOAD指令</span>
           <span class="token comment">// 0-LB 1-LH 2-LW 4-LBU 5-LHU</span>
        <span class="token keyword">case</span> <span class="token number">0x23</span><span class="token operator">:</span> <span class="token comment">//STORE(0b0100011)</span>
           <span class="token comment">// 分支处理写外设和写存储</span>
           <span class="token comment">// 写外设有一个写SYSCON.更新PC然后返回rs2即可</span>
           <span class="token comment">// 写存储内部又会根据(ir>>12) &amp; 0x7值区分STORE指令</span>
           <span class="token comment">// 0-SB 1-SH 2-SW</span>
        <span class="token keyword">case</span> <span class="token number">0x13</span><span class="token operator">:</span> <span class="token comment">// Op-immediate 0b0010011</span>
        <span class="token keyword">case</span> <span class="token number">0x33</span><span class="token operator">:</span> <span class="token comment">// Op 0b0110011</span>
            <span class="token comment">//处理RV32M的op inst</span>
            <span class="token comment">//处理RV32I的op和op-imm inst</span>
        <span class="token keyword">case</span> <span class="token number">0x0f</span><span class="token operator">:</span> <span class="token comment">//fence</span>
            <span class="token comment">//直接写目的寄存器0</span>
        <span class="token keyword">case</span> <span class="token number">0x73</span><span class="token operator">:</span> <span class="token comment">//Zifencei+Zicsr</span>
            <span class="token comment">// (ir >> 12) &amp; 0x7 低两位不全为0 那么是CSR指令</span>
            <span class="token comment">// (ir >> 12) &amp; 0x7 为0，系统调用指令 WFI mret ecall ebreak</span>
        <span class="token keyword">case</span> <span class="token number">0x2f</span><span class="token operator">:</span> <span class="token comment">//RV32A</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trap<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> cycle_end<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>rdid<span class="token punctuation">)</span>
            state<span class="token operator">-></span>regs<span class="token punctuation">[</span>rdid<span class="token punctuation">]</span> <span class="token operator">=</span> rval<span class="token punctuation">;</span>
       
</pre></div></code-block></li></ul></li></ol><h3 id="6ujuWH56NEL4jXCJd8ZXkH" class="wolai-block"><span class="inline-wrap">硬件与软件的发展历史</span></h3><div id="tnqvNVEN3DkLjSXeH5Mghi" class="wolai-block"><figure class="wolai-center" style="width: 100%; flex-direction: column"><img src="media/image_2.png" style="width: 100%"/></figure></div><div id="4kikj1LN3Z6SoAVseGh8Nf" class="wolai-block wolai-text"><div><span class="inline-wrap">本节讨论的是</span><span class="blue inline-wrap"><b>狭义的操作系统，它是对单机（多处理器）进行抽象，支撑多个程序执行</b></span></div></div><ul class="wolai-block"><li id="9HUtkbBeiTPMZCRrh52289"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">1940s</span><div id="u5QLTjzvh8Ezd5UBnzVCf9" class="wolai-block wolai-text"><div><span class="inline-wrap">这个年代，</span><span class="green inline-wrap"><u>主要是通过打孔纸带/指示灯进行输入输出，使用延迟线来制作存储器</u></span></div></div><div id="qLyAZesBvVVUj3mCoKhoSu" class="wolai-block wolai-text"><div><span class="inline-wrap">使用</span><span class="green inline-wrap"><u>真空电子管作为逻辑门</u></span><span class="inline-wrap">实现的</span><span class="green inline-wrap"><u>ENIAC</u></span><span class="inline-wrap"></span><span class="green inline-wrap"><u>，通过跳转表，连接电路线进行编程</u></span><span class="inline-wrap">，这时的</span><span class="green inline-wrap"><u>程序主要是打印平方数、素数表、计算弹道等</u></span><span class="inline-wrap">，这时</span><span class="green inline-wrap"><u>遇到的“Bug”也是真正的<span class="jill"></span>Bug</u></span><span class="inline-wrap">。因为</span><span class="green inline-wrap"><b>这时程序使用指令操作硬件，因此没有操作系统</b></span></div></div></li><li id="a1QKCndHpLzQMZgJtPTjaQ"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">1950s~1960s</span><div id="qb3CZoAhA8g3kTprCX4vce" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>逻辑门、存储器以及<span class="jill"></span>I/O<span class="jill"></span>的构造改变了，但是</u></span><span class="green inline-wrap"><u><b>逻辑门-存储器-I/O</b></u></span><span class="green inline-wrap"><u>的格局没有变</u></span></div><div id="u4sCZF8kzdfZUpwdtLuQ44" class="wolai-block wolai-text"><div><span class="inline-wrap">逻辑门：用晶体管实现</span></div></div><div id="Twyn4Zdp1oPQtxtrkFQ9D" class="wolai-block wolai-text"><div><span class="inline-wrap">存储器：用磁芯实现</span></div></div><div id="6nLy46HRCkGvDVFSiMykne" class="wolai-block wolai-text"><div><span class="inline-wrap">I/O：更多丰富的<span class="jill"></span>I/O</span></div></div></div><div id="7bPQDYAU92ZBJEFvxDv7PV" class="wolai-block wolai-text"><div><span class="inline-wrap">这时，因为<span class="jill"></span>I/O<span class="jill"></span>的速度严重低于处理器的速度，所以出现了</span><span class="green inline-wrap"><u>中断机制</u></span><span class="inline-wrap">。而且，</span><span class="green inline-wrap"><u>出现了<span class="jill"></span>FORTRAN<span class="jill"></span>这种高级语言，有了一行<span class="jill"></span>80<span class="jill"></span>字符的标准</u></span><span class="inline-wrap">。而且，会有<span class="jill"></span>operator<span class="jill"></span>来负责取卡片送卡片，因此</span><span class="green inline-wrap"><u>有了操作系统的概念</u></span></div></div><div id="wsvLz7YvQodSWfxC9tXch5" class="wolai-block wolai-text"><div><span class="inline-wrap">而且，这个时候</span><span class="green inline-wrap"><u>有了<span class="jill"></span>CTSS，操作系统出现了各类对象：设备、文件、任务</u></span></div></div></li><li id="rjG4q1fcvuGtgwd5GoNYV9"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">1960s~1970s</span><div id="uoi8p35F1BNLBi1Ay1sPpi" class="wolai-block"><figure class="wolai-left" style="width: 345.6px; flex-direction: column"><img src="media/image_3.png" style="width: 100%"/></figure></div><div id="geS7DpzPToQSTj7tFkcbXp" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>开始出现集成电路和总线，然后使用集成电路芯片来做处理器和存储以及更多的高级语言和编译器，有了进程的概念、虚拟存储以及进程切换，开始诞生了现代分时操作系统</u></span></div></div></li><li id="iuQHAyZPQw6wbqw6dQp4e4"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">1970s<span class="jill"></span>以后</span><div id="7akSujmVZkMhe3syaS5xXh" class="wolai-block wolai-text"><div><span class="green inline-wrap"><u>分时系统走向了成熟，诞生了<span class="jill"></span>UNIX，奠定了现代操作系统的形态</u></span></div></div></li></ul><div id="tviaT9X87N6tBzdFGFeWKV" class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>